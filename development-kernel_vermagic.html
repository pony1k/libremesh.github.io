<!doctype html>

<!--[if IE 9]>
<html class="lt-ie10" lang="en"> <![endif]-->
<html lang="en" class="no-js" data-useragent="Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; Trident/6.0)">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Compiling firmware compatible with OpenWrt repository Kernel vermagic</title>


    <meta name="description"
          content="The LibreMesh project, a set of tools for making the free networks possible"/>
	
    <link rel="stylesheet" href="/css/foundation.css"/>
    <link rel="stylesheet" href="/css/font-awesome.css"/>
    <link rel="stylesheet" href="/css/coderay.css"/>
    <link rel="stylesheet" href="/css/asciidoctor.css"/>
    <link rel="stylesheet" href="/css/lime.css"/>
    <script src="/js/vendor/modernizr.js"></script>
    <script src="/js/toc.js"></script>

</head>
<body>


<!-- Nav Bar -->

<nav class="top-bar" data-topbar>
    <ul class="title-area">
        <!-- Title Area -->
        <li class="name">
            <h1>
                <a href="">
                    <img src="/logo/logo_nano.png"></img>
                    <span class="top-bar-title">LibreMesh</span>
                </a>
            </h1>
        </li>
	<li class="toggle-topbar menu-icon"><a href=""><span>Menu</span></a></li>
    </ul>
    
<!-- lang --> 
<ul class="lng">





  <li>
    <a href="/development-kernel_vermagic.html" class="en">en</a>
  </li>

    </ul>
<!-- fine lang-->

    <section class="top-bar-section">
        <!-- Right Nav Section -->
        <ul class="right">
            
    <!-- Use the current language and default to english if doc translation is not found -->
    
    
    
    <li ><a href="/">Home</a></li>

    <!-- Use the current language and default to english if doc translation is not found -->
    
    
    
    <li ><a href="/news.html">News</a></li>

    <!-- Use the current language and default to english if doc translation is not found -->
    
    
    
    <li ><a href="/communication.html">Communication</a></li>

    <!-- Use the current language and default to english if doc translation is not found -->
    
    
    
    <li ><a href="/getit.html">Get it!</a></li>

    <!-- Use the current language and default to english if doc translation is not found -->
    
    
    
    <li ><a href="/howitworks.html">How it works</a></li>

    <!-- Use the current language and default to english if doc translation is not found -->
    
    
    
    <li ><a href="/development.html">Development</a></li>

    <!-- Use the current language and default to english if doc translation is not found -->
    
    
    
    <li ><a href="/docs/">Documentation</a></li>

    <!-- Use the current language and default to english if doc translation is not found -->
    
    
    
    <li ><a href="/about.html">About</a></li>


        </ul>
    </section>
</nav>
<!-- End Nav -->


<!-- Main Page Content and Sidebar -->

<div class="row">
    <!-- Docs Sidebar -->

    

    <!-- End Docs Sidebar -->

    <!-- Main Blog Content -->
    <div class="large-9 columns" role="content">

        <div class="sectionbody ">
            
            <div class="paragraph text-right">
                <p>
                    <span class="icon"><i class="fa fa-edit"></i></span>
                    <a href="https://github.com/libremesh/libremesh.github.io/edit/master/development-kernel_vermagic.txt">Edit this page</a>
                </p>
            </div>
        </div>

        <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#reference">Reference</a></li>
<li><a href="#the_problem">The problem</a></li>
<li><a href="#generic_instructions">Generic instructions</a></li>
<li><a href="#additional_targetsubtarget_specific_selections">Additional target/subtarget specific selections</a></li>
<li><a href="#my_targetsubtarget_is_not_present_in_the_table">My target/subtarget is not present in the table</a></li>
</ul>
</div>
<div class="sect1">
<h2 id="reference">Reference</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This page is an optional expansion to the normal compilation procedure suggested in the <a href="development.html">development page</a> and is an expansion of <a href="https://web.archive.org/web/20220716110253/https://lists.libremesh.org/archives/list/lime-users@lists.libremesh.org/message/AWSAUYSKEXN5GNORLIYHPJP5LIWAC5EQ/">this explorative email</a>.
Beware that these additional steps result in a more time and disk space consuming compilation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="the_problem">The problem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OpenWrt offers the amazing possibility to add more software to the firmware both at compilation time or subsequently.
The former possibility always works: if you can, always select the packages you need in the menuconfig at compilation time.
The latter possibility can show some compatibility issues between the custom installed image and the packages available on OpenWrt repositories, and that&#8217;s what this page tries to fix.</p>
</div>
<div class="paragraph">
<p>This compatibility issue arises just with packages depending on some kernel module, for example the <a href="https://openwrt.org/packages/pkgdata/tc">tc</a> package. These packages require a specific kernel version to be present. And in OpenWrt the kernel version includes the hash of the configuration used for compiling it, which is a part of the general compilation configuration, so that the kernel version will include a <strong>vermagic</strong> which looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># opkg info kernel
Version: 4.14.195-1-b84a5a29b1d5ae1dc33ccf9ba292ca1d</pre>
</div>
</div>
<div class="paragraph">
<p>So, in order to be able to install some specific packages using OPKG, you need to have compiled the kernel exactly in the same way as the one used in the official OpenWrt repositories.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="generic_instructions">Generic instructions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>These are the minimal instructions to follow, check in the section below whether additional selections are needed for the target/subtarget of your device.</p>
</div>
<div class="paragraph">
<p>In the menuconfig, at LibreMesh <a href="development.html">compilation time</a>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Select: Advanced configuration options</p>
</li>
<li>
<p>Select: Global build settings &#8594; Select all kernel module packages by default</p>
</li>
<li>
<p>Deselect: Global build settings &#8594; Kernel build options &#8594; Compile the kernel with symbol table information</p>
</li>
<li>
<p>Fill with <code>builder</code>: Global build settings &#8594; Kernel build options &#8594; Custom Kernel Build User Name</p>
</li>
<li>
<p>Fill with <code>buildhost</code>: Global build settings &#8594; Kernel build options &#8594; Custom Kernel Build Domain Name</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>then check if your device requires additional selections in the following table and finally continue with the <a href="development.html">normal procedure</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="additional_targetsubtarget_specific_selections">Additional target/subtarget specific selections</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Make sure to do all the 5 selections/deselections/filling listed in the previous section.
If you don&#8217;t know the target and subtarget of your router, check out <a href="https://openwrt.org/toh/start">OpenWrt table of hardware</a>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Additional steps to perform in the menuconfig for specific subtargets</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Target</th>
<th class="tableblock halign-left valign-top">Subtarget</th>
<th class="tableblock halign-left valign-top">Additional things to select</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Atheros ATH79 (DTS)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MediaTek Ralink MIPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MT7620 based boards</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">MediaTek Ralink MIPS</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MT7621 based boards</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Atheros AR7xxx/AR9xxx (ar71xx)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Generic</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">x86</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">x86_64</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">&#8201;&#8212;&#8201;</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="my_targetsubtarget_is_not_present_in_the_table">My target/subtarget is not present in the table</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, make sure that the "Generic instructions" aren&#8217;t enough!
If after compiling and flashing an image following the "Generic instructions" you still get errors like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># opkg install tc
&gt;&gt;&gt;&gt; Collected errors:
&gt;&gt;&gt;&gt;  * satisfy_dependencies_for: Cannot satisfy the following dependencies
&gt;&gt;&gt;&gt; for tc:
&gt;&gt;&gt;&gt;  * 	kernel (= 4.9.214-1-2b8f9dfe583e5c09aadd9474da55137f)
&gt;&gt;&gt;&gt;  * opkg_install_cmd: Cannot install package tc.</pre>
</div>
</div>
<div class="paragraph">
<p>you can try to find out which kernel modules you&#8217;re missing (you don&#8217;t actually need them, it&#8217;s just for having the kernel version matching exactly the one required by the packages on OpenWrt repositories) following this procedure:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>check the kernel version you need, included the vermagic hash, this can be found in various ways, for example in the <code>kmods</code> subdirectory (in the downloads.openwrt.org website) at the bottom of the web page where you would download the OpenWrt images. This page is specific for the OpenWrt version you&#8217;re using, the target and the subtarget: the complete URL would be something like: https://downloads.openwrt.org/releases/\release_version\]/targets/[target_system/[subtarget]/kmods and this will contain another subdirectory named as the complete kernel version. For example, for OpenWrt19.07.10/ATH79/generic you can find it <a href="https://downloads.openwrt.org/releases/19.07.10/targets/ath79/generic/kmods/">here</a>;</p>
</li>
<li>
<p>download the <code>config.buildinfo</code> file for the target/subtarget of your device, you can find it in the same directory from where you download the official OpenWrt images, at the bottom of the page. The complete direction is something like: https://downloads.openwrt.org/releases/\release_version\]/targets/[target_system/[subtarget]/config.buildinfo for example, for OpenWrt19.07.10/ATH79/generic you can find it <a href="https://downloads.openwrt.org/releases/19.07.10/targets/ath79/generic/config.buildinfo">here</a>;</p>
</li>
<li>
<p>make a backup copy of the original <code>config.buildinfo</code>;</p>
</li>
<li>
<p>modify the config.buildinfo file removing some lines;</p>
<div class="paragraph">
<p>Do not remove the following lines:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>CONFIG_TARGET_name_of_wanted_target=y
CONFIG_ALL_KMODS=y
CONFIG_DEVEL=y
# CONFIG_KERNEL_KALLSYMS is not set
CONFIG_KERNEL_BUILD_DOMAIN="buildhost"
CONFIG_KERNEL_BUILD_USER="builder"</pre>
</div>
</div>
<div class="paragraph">
<p>neither the CONFIG_KERNEL_KALLSYMS one which is needed even if it is commented out. All these options are the ones mentioned in the "General instructions" above.</p>
</div>
</li>
<li>
<p>Copy it into your OpenWrt buildroot compilation directory and rename the copy as <code>.config</code> (overwrite if necessary) which is the hidden file containing the configuration for the compilation, which will get modified from menuconfig.</p>
</li>
<li>
<p>Run <code>make defconfig</code> to generate the rest of the <code>.config</code> file (you can do the same using <code>make menuconfig</code>).</p>
</li>
<li>
<p>Run <code>make target/linux/compile</code> to compile the minimum amount of stuff needed to obtain the kernel vermagic hash (even if the compilation got an error and did not reach completion).</p>
</li>
<li>
<p>Check the kernel vermagic which will be in a file in your OpenWrt buildroot like this: <code>./build_dir/target-mips_24kc_musl/linux-ath79_generic/linux-4.14.195/.vermagic</code> you can try with the command:</p>
<div class="literalblock">
<div class="content">
<pre>cat ./build_dir/target-*/linux-*/linux-*/.vermagic</pre>
</div>
</div>
</li>
<li>
<p>If the string matches the kernel vermagic hash from point 1, good! Otherwise, repeat from point 4 removing more lines, compiling again and checking again if the hash matches.</p>
</li>
<li>
<p>The minimum set of lines needed to have a matching hash are enough, but if you want to take it down to the single kernel configuration you can check which lines appears in the <code>./build_dir/target-mips_24kc_musl/linux-ath79_generic/linux-4.14.195/.config.set</code> file (adapt the path to your target) due to the new content of the <code>.config</code> file.</p>
</li>
<li>
<p>Confirm that this works compiling a full image (continuing with the compilation guide), flashing it on your device and installing some package depending on a kernel module (e.g. the <code>tc</code> package) using <code>opkg install</code> command.</p>
</li>
<li>
<p>If you had to keep the lines of some profiles (devices) in order to obtain the good vermagic, please check which kernel modules they depend upon, you can find this information in the menuconfig using the "Help" function when you are on the selected profile: all the packages starting with <code>kmod-</code> are kernel modules, most of them are selected by default but there will be some that are not. Note them down and check which are not selected when running the menuconfig after deleting the <code>.config</code> file.</p>
</li>
<li>
<p>If you go through all of this craziness, please report to this page your discoveries! You can file a pull request on the <a href="https://github.com/libremesh/libremesh.github.io">website repository</a> using the "Edit this page" button at the top right of this page or <a href="https://libremesh.org/communication.html">contacting us</a>. Thanks!</p>
</li>
</ol>
</div>
</div>
</div>

    </div>

    <!-- End Main Content -->

    <!-- Sidebar -->

    
    <aside class="large-3 columns">
        <h4>Links</h4>
<div class="panel">
    <ul class="fa-ul">
        <li><i class="fa-li fa fa-download" aria-hidden="true"></i><a href="https://downloads.libremesh.org/current/">Latest Release Firmware</a></li>
        <li><i class="fa-li fa fa-linux" aria-hidden="true"></i><a href="development.html">Build Firmware Locally</a></li>
        <li><i class="fa-li fa fa-code-fork" aria-hidden="true"></i><a href="https://github.com/libremesh/">Source Code</a></li>
        <li><i class="fa-li fa fa-envelope" aria-hidden="true"></i><a href="https://www.autistici.org/mailman/listinfo/libremesh">Mailing List</a></li>
        <li><i class="fa-li fa fa-comments" aria-hidden="true"></i><a href="https://matrix.to/#/#libremesh-dev:matrix.guifi.net">Element Chatroom</a></li>
    </ul>
</div>

    </aside>
    

    <!-- End Sidebar -->
</div>

<!-- End Main Content and Sidebar -->


<!-- Footer -->

<footer class="row">
    <div class="large-12 columns">
        <hr/>
        <div class="row">
            <div class="large-12 columns">
                <p>Last updated 2023-12-01 13:47:38</p>
            </div>
        </div>
    </div>
</footer>

<script src="/js/vendor/jquery.js"></script>
<script src="/js/foundation.min.js"></script>
<script>
    $(document).foundation();

    var doc = document.documentElement;
    doc.setAttribute('data-useragent', navigator.userAgent);
</script>
</body>
</html>
